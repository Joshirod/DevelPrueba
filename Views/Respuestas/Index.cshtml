@model DevelPrueba.ViewModels.ResultsVm
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Respuestas";
    var cols = Model.Columnas ?? new List<string>();
    var rows = Model.Filas ?? new List<List<string>>();
    var respuestasCount = rows.Count;
}

<div class="d-flex align-items-center justify-content-between mb-3">
    <div>
        <h2 class="mb-0">Respuestas: @Model.EncuestaNombre</h2>
        <div class="text-muted">
            @respuestasCount respuesta@(respuestasCount == 1 ? "" : "s")
        </div>
    </div>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary"
           asp-controller="Encuestas" asp-action="Details"
           asp-route-id="@ViewContext.RouteData.Values["id"]">
            Volver a encuesta
        </a>
        <!-- Export link (controller: Respuestas / action: ExportCsv / route-id required) -->
        <a class="btn btn-outline-primary"
           asp-controller="Respuestas" asp-action="ExportCsv"
           asp-route-id="@ViewContext.RouteData.Values["id"]">
            Exportar CSV
        </a>
    </div>
</div>

@if (respuestasCount == 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center text-muted py-5">
            Aún no hay respuestas para esta encuesta.
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="row g-2 mb-3">
                <div class="col-12 col-md-6">
                    <input id="searchBox" class="form-control" placeholder="Buscar en resultados..." />
                </div>
            </div>

            <div class="table-responsive" style="max-height: 70vh;">
                <table class="table table-sm align-middle" id="tblRespuestas">
                    <thead class="table-light" style="position: sticky; top: 0; z-index: 2;">
                        <tr>
                            @foreach (var c in cols)
                            {
                                <th>@c</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @for (int r = 0; r < rows.Count; r++)
                        {
                            var fila = rows[r] ?? new List<string>();
                            <tr data-row>
                                @for (int c = 0; c < cols.Count; c++)
                                {
                                    var cell = (c < fila.Count ? fila[c] : null) ?? "";
                                    <td>@(string.IsNullOrWhiteSpace(cell) ? Html.Raw("<span class=\"text-muted\">—</span>") : cell)</td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        (function(){
            // Simple client-side search across all cells
            const box = document.getElementById('searchBox');
            if(!box) return;
            const rows = Array.from(document.querySelectorAll('#tblRespuestas tbody tr[data-row]'));

            function norm(s){ return (s||'').toString().toLowerCase().trim(); }

            function apply(){
                const q = norm(box.value);
                let visible=0;
                rows.forEach(tr=>{
                    const txt = norm(tr.innerText);
                    const show = !q || txt.includes(q);
                    tr.style.display = show ? '' : 'none';
                    if(show) visible++;
                });

                let emptyRow = document.getElementById('noMatch');
                if(!emptyRow){
                    emptyRow = document.createElement('tr');
                    emptyRow.id = 'noMatch';
                    const cols = document.querySelectorAll('#tblRespuestas thead th').length || 1;
                    emptyRow.innerHTML = `<td colspan="${cols}" class="text-center text-muted py-4">Sin coincidencias</td>`;
                    document.querySelector('#tblRespuestas tbody').appendChild(emptyRow);
                }
                emptyRow.style.display = (visible===0) ? '' : 'none';
            }

            box.addEventListener('input', apply);
        })();
    </script>
}
